name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_ID: luminous-return-441222-f4
  PROJECT_NUM: "745280192718"
  GKE_CLUSTER: stock-insight-cluster
  GKE_ZONE: us-west1-a
  IMAGE: us-central1-docker.pkg.dev/luminous-return-441222-f4/tradeseer-repo/tradeseer-ai

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      run: |
        if [ -d "tests" ]; then
          python -m pytest tests/ -v
        else
          echo "No tests directory found"
        fi
      continue-on-error: true

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ env.PROJECT_ID }}
        export_default_credentials: true
    
    - name: Authenticate Docker
      run: |
        echo '${{ secrets.GCP_SA_KEY }}' > ${HOME}/gcp-key.json
        gcloud auth activate-service-account --key-file=${HOME}/gcp-key.json
        gcloud config set project ${{ env.PROJECT_ID }}
        gcloud auth configure-docker us-central1-docker.pkg.dev --quiet
        rm ${HOME}/gcp-key.json
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build and Push Image
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        docker buildx build \
          --platform linux/amd64 \
          -t ${{ env.IMAGE }}:${SHORT_SHA} \
          -t ${{ env.IMAGE }}:latest \
          --push .

  deploy:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ env.PROJECT_ID }}
    
    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
          --zone ${{ env.GKE_ZONE }} \
          --project ${{ env.PROJECT_ID }}
    
    - name: Deploy to Kubernetes
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        kubectl set image deployment/stock-insight \
          stock-insight=${{ env.IMAGE }}:${SHORT_SHA}
        kubectl rollout status deployment/stock-insight --timeout=5m
    
    - name: Verify Deployment
      run: |
        kubectl get pods -l app=stock-insight
        kubectl get svc stock-insight-service
        EXTERNAL_IP=$(kubectl get svc stock-insight-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        echo "Deployed to: http://${EXTERNAL_IP}"